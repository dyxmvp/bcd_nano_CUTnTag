---
title: "R Notebook"
output: html_notebook
params:
  out_prefix: "/data/proj/GCB_MB/bcd_CT/single-cell/results/"
---

```{r}
library(Seurat)
library(Signac)
library(ggplot2)
library(ggthemes)
library(purrr)
library(caret)

set.seed(1234)
```

```{r,fig.width=10,fig.height=4}
seurat.ls <- readRDS(file=paste0(params$out_prefix,'/multiple_modalities/ATAC_H3K27ac_H3K27me3/seurat_multimodal/peaks/Seurat_object.Rds'))

metadata <- list()

for(i in 1:length(seurat.ls[1:3])){
    metadata[[i]]                       <- as.data.frame(seurat.ls[[i]]@meta.data[,'logUMI'])
    metadata[[i]]$cell_barcode          <- rownames(seurat.ls[[i]]@meta.data)
    metadata[[i]]$modality              <- unique(seurat.ls[[i]]$modality)
    metadata[[i]]$experiment            <- seurat.ls[[i]]@meta.data[,'sample']
    colnames(metadata[[i]])             <- c('logUMI','cell_barcode','modality','sample')
}

metadata <- purrr::reduce(.x = metadata,.f = rbind)

ggplot(data=metadata) + geom_violin(aes(x=sample,fill=modality,y=logUMI),width=0.6) + theme_classic() + theme(text = element_text(size=16)) + xlab("")
ggsave(filename = paste0(params$out_prefix,'/figures/figure_2/Violin_logUMI.pdf'),width=10,height=4,bg='transparent')

```


```{r,fig.width=10,fig.height=4}
seurat.ls <- readRDS(file=paste0(params$out_prefix,'/multiple_modalities/ATAC_H3K27ac_H3K27me3/seurat_multimodal/peaks/Seurat_object.Rds'))

metadata <- list()

for(i in 1:length(seurat.ls[1:3])){
    metadata[[i]]                       <- as.data.frame(seurat.ls[[i]]@meta.data[,'peak_ratio_MB'])
    metadata[[i]]$cell_barcode          <- rownames(seurat.ls[[i]]@meta.data)
    metadata[[i]]$modality              <- unique(seurat.ls[[i]]$modality)
    metadata[[i]]$experiment            <- seurat.ls[[i]]@meta.data[,'sample']
    colnames(metadata[[i]])             <- c('FrIP','cell_barcode','modality','sample')
}

metadata <- purrr::reduce(.x = metadata,.f = rbind)

ggplot(data=metadata,aes(x=sample,fill=modality,y=FrIP)) + 
  geom_violin(width=0.6) + 
  theme_classic() + 
  theme(text = element_text(size=16)) + xlab("")
ggsave(filename = paste0(params$out_prefix,'/figures/figure_2/Violin_FrIP.pdf'),width=10,height=4,bg='transparent')

```



```{r, fig.width=15, fig.height=5}
seurat <- readRDS(file=paste0(params$out_prefix,'/multiple_modalities/ATAC_H3K27ac_H3K27me3/seurat_multimodal/peaks/Seurat_object.Rds'))


nmodalities      = 3 
umap_embeddings <- list()

for(i in 1:length(seurat[1:nmodalities])){
  umap_embeddings[[i]]               <- as.data.frame(seurat[[i]]@reductions[['umap']]@cell.embeddings)
  umap_embeddings[[i]]$UMAP_1        <- umap_embeddings[[i]]$UMAP_1 + (i-1)*40
  umap_embeddings[[i]]$modality      <- unique(seurat[[i]]$modality)
  umap_embeddings[[i]]$cluster       <- seurat[[i]]$idents_L1
  umap_embeddings[[i]]$cell_barcode  <- rownames(umap_embeddings[[i]])

}

umap.embeddings.merge               <- purrr::reduce(umap_embeddings,rbind)
common.cells                        <- table(umap.embeddings.merge$cell_barcode)
common.cells                        <- names(common.cells[common.cells==nmodalities])

umap.embeddings.merge               <- umap.embeddings.merge[umap.embeddings.merge$cell_barcode %in% common.cells,]

# ggplot(data=umap.embeddings.merge,aes(x=UMAP_1,y=UMAP_2,col=cluster)) + geom_point(size=0.2) + geom_line()

cells.connect <- sample(umap.embeddings.merge$cell_barcode,5000)


p1 <- ggplot(data=umap.embeddings.merge,aes(x=UMAP_1,y=UMAP_2,col=cluster)) + 
  geom_point(size=0.05) + 
  geom_line(data=umap.embeddings.merge, aes(group=cell_barcode,col=cluster),alpha=0.2,size=0.02) + 
  theme_classic() + NoAxes() + NoLegend() 

p1

dir.create(paste0(params$out_prefix,'/figures/figure_2/'))
ggsave(filename = paste0(params$out_prefix,'/figures/figure_2/UMAP_with_connections.png'),width=15,height=5,bg='transparent')
```

```{r,fig.width=6,fig.height=6}
seurat <- readRDS(file=paste0(params$out_prefix,'/multiple_modalities/ATAC_H3K27ac_H3K27me3/seurat_multimodal/peaks/Seurat_object.Rds'))
nmodalities      = 3 
metadata <- list()
```

```{r,fig.width=6,fig.height=6}
cm <- function(seurat.ls,id.x = 1, id.y = 2, identities = 'seurat_clusters'){
  for(i in 1:length(seurat.ls)){
    metadata[[i]]                       <- as.data.frame(seurat.ls[[i]]@meta.data[,identities])
    metadata[[i]]$cell_barcode          <- rownames(seurat.ls[[i]]@meta.data)
    metadata[[i]]$modality              <- unique(seurat.ls[[i]]$modality)
    colnames(metadata[[i]])             <- c('cluster','cell_barcode','modality')
  }
  
  all.factors <- unique(purrr::reduce(lapply(metadata,function(x){x$cluster}),c))
  metadata    <- lapply(metadata,function(x){x$cluster <- factor(x$cluster,levels=all.factors);return(x) })

  a       <- merge(metadata[[id.x]],metadata[[id.y]],by='cell_barcode')
  a       <- a[,c('cluster.x','cluster.y')]
  a       <- table(a)
  a       <- a[rowSums(a) > 0, colSums(a) > 0]
  a       <- a[order(rowSums(a),decreasing = TRUE),]
  a       <- apply(a,1,function(x){x/(sum(x))})
  
  # Re-order the matrix
  row.max <- unname(apply(a,1,which.max))
  row.max <- unique(colnames(a)[row.max])
  row.max <- c(row.max, setdiff(colnames(a),row.max))

  a <- a[,row.max]
  
  return(a)
  
  # pheatmap(mat = to.plot)
}

library(pheatmap)
library(viridis)

combinations <- unlist(apply(combn(1:nmodalities,2),2,list),recursive = FALSE)
identities   <- c("idents_L1","idents_L2","idents_L3","seurat_clusters")

cm.list <- lapply(identities, function(ident){
  pdf(paste0(params$out_prefix,'/figures/figure_2/Confusion_matrix_',ident,'.pdf'),width = 10,height=10)
  lapply(combinations,function(comb){
    cm1 <- cm(seurat[1:3],id.x = comb[1],id.y = comb[2],identities = ident)
    names(cm1) <- identities
    p <- pheatmap(cm1,
             cluster_rows = F,
             cluster_cols = F,
             main = paste(unique(seurat[[comb[1]]]$modality),
                          unique(seurat[[comb[2]]]$modality),
                          ident),fontsize = 30)
    # plot.new()
    return(p)
  })
  dev.off()
})

```



